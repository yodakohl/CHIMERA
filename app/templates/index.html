<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Satellite Infrastructure Scanner</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <header>
      <h1>Satellite Infrastructure Scanner</h1>
      <p>
        Upload high-resolution satellite imagery and let the system look for unusual
        infrastructure. The analyzer combines image captioning, open-ended visual question
        answering, and general-purpose object detection to surface noteworthy findings.
      </p>
    </header>

    {% if message %}
    <div class="flash">{{ message }}</div>
    {% endif %}

    <section class="upload">
      <form class="form-card" action="/analyze" method="post" enctype="multipart/form-data">
        <label for="image">Satellite image</label>
        <input id="image" name="image" type="file" accept="image/*" required />

        <label for="prompt">Analysis prompt</label>
        <textarea id="prompt" name="prompt" rows="3">{{ default_prompt }}</textarea>

        <button type="submit">Analyze image</button>
      </form>
    </section>

    <section class="area">
      <h2>Automatic area scan</h2>
      <p>
        Request imagery for a latitude/longitude bounding box and the scanner will automatically
        download tiles from the selected provider before running the analysis pipeline on each tile.
        MapTiler's global satellite basemap is the default for crisp worldwide coverage, with NASA's
        GIBS mosaics and the USGS NAIP aerial program available as alternatives when desired.
      </p>
      <form class="form-card" action="/scan-area" method="post">
        <div class="form-grid">
          <div class="field">
            <label for="north">North latitude</label>
            <input
              id="north"
              name="north"
              type="number"
              step="0.0001"
              min="-90"
              max="90"
              value="{{ '%.4f'|format(default_bounds.north) }}"
              required
            />
          </div>
          <div class="field">
            <label for="south">South latitude</label>
            <input
              id="south"
              name="south"
              type="number"
              step="0.0001"
              min="-90"
              max="90"
              value="{{ '%.4f'|format(default_bounds.south) }}"
              required
            />
          </div>
          <div class="field">
            <label for="west">West longitude</label>
            <input
              id="west"
              name="west"
              type="number"
              step="0.0001"
              min="-180"
              max="180"
              value="{{ '%.4f'|format(default_bounds.west) }}"
              required
            />
          </div>
          <div class="field">
            <label for="east">East longitude</label>
            <input
              id="east"
              name="east"
              type="number"
              step="0.0001"
              min="-180"
              max="180"
              value="{{ '%.4f'|format(default_bounds.east) }}"
              required
            />
          </div>
          <div class="field">
            <label for="tile-size">Tile size (degrees)</label>
            <input
              id="tile-size"
              name="tile_size"
              type="number"
              step="0.01"
              min="{{ '%.2f'|format(min_tile_size) }}"
              max="{{ '%.2f'|format(max_tile_size) }}"
              value="{{ '%.2f'|format(default_tile_size) }}"
              required
            />
          </div>
          <div class="field">
            <label for="provider">Imagery source</label>
            <select id="provider" name="provider">
              {% for option in providers %}
              <option
                value="{{ option.key }}"
                title="{{ option.description }}"
                {% if option.key == selected_provider %}selected{% endif %}
              >
                {{ option.label }}
              </option>
              {% endfor %}
            </select>
            <p class="hint">Hover the options for coverage and resolution details.</p>
          </div>
          <div class="field">
            <label for="date">Acquisition date (optional)</label>
            <input
              id="date"
              name="date"
              type="date"
              {% if default_date %}value="{{ default_date }}"{% endif %}
            />
          </div>
        </div>
        <div class="form-actions">
          <button type="button" id="global-scan" class="secondary-button">
            Use worldwide coverage
          </button>
          <span class="hint">
            Prefills the form with global bounds and the largest supported tile size.
          </span>
        </div>
        <p class="hint">
          Large areas may require increasing the tile size to stay under the built-in limit of 50
          imagery requests per scan.
        </p>

        <label for="area-prompt">Analysis prompt</label>
        <textarea id="area-prompt" name="prompt" rows="3">{{ default_prompt }}</textarea>

        <button type="submit">Scan area</button>
      </form>
    </section>

    <section class="usage results">
      <h2>API usage</h2>
      {% if api_usage %}
      <table>
        <thead>
          <tr>
            <th>Provider</th>
            <th>Requests</th>
            <th>Last used</th>
          </tr>
        </thead>
        <tbody>
          {% for entry in api_usage %}
          <tr>
            <td>{{ entry.provider_label }}</td>
            <td>{{ entry.request_count }}</td>
            <td>
              {% if entry.last_used_at %}
              {{ entry.last_used_at.strftime('%Y-%m-%d %H:%M:%S') }}
              {% else %}
              &mdash;
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p>No API requests have been recorded yet.</p>
      {% endif %}
    </section>

    <section class="results">
      <h2>Analysis history</h2>
      {% if results %}
      <table>
        <thead>
          <tr>
            <th>Timestamp</th>
            <th>Image</th>
            <th>Caption</th>
            <th>Unusual findings</th>
            <th>Detected objects</th>
          </tr>
        </thead>
        <tbody>
          {% for result in results %}
          <tr>
            <td>{{ result.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
            <td>
              <a href="/data/uploads/{{ result.image_filename }}" target="_blank">
                {{ result.image_filename }}
              </a>
            </td>
            <td>{{ result.caption }}</td>
            <td>{{ result.unusual_summary }}</td>
            <td>
              {% if result.detections %}
              <ul>
                {% for detection in result.detections %}
                <li>
                  <strong>{{ detection["object"] }}</strong>
                  (confidence {{ '%.2f'|format(detection["confidence"]) }})
                  {% set answers = detection.get('answers') %}
                  {% if answers %}
                  <div class="meta">Model answers: {{ answers|join(', ') }}</div>
                  {% endif %}
                  {% set box = detection.get('box') %}
                  {% if box %}
                  <div class="meta">
                    Bounding box: xmin {{ box["xmin"] }}, ymin {{ box["ymin"] }}, xmax
                    {{ box["xmax"] }}, ymax {{ box["ymax"] }}
                  </div>
                  {% endif %}
                </li>
                {% endfor %}
              </ul>
              {% else %}
              <em>No objects detected above the confidence threshold</em>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p>No analyses have been recorded yet. Upload your first satellite scene to begin.</p>
      {% endif %}
    </section>
    <script>
      (function () {
        const button = document.getElementById("global-scan");
        if (!button) return;
        button.addEventListener("click", function () {
          const north = document.getElementById("north");
          const south = document.getElementById("south");
          const east = document.getElementById("east");
          const west = document.getElementById("west");
          const tile = document.getElementById("tile-size");
          if (north) north.value = "90";
          if (south) south.value = "-90";
          if (east) east.value = "180";
          if (west) west.value = "-180";
          if (tile) tile.value = "{{ '%.2f'|format(max_tile_size) }}";
        });
      })();
    </script>
  </body>
</html>
